# GeoJSON Flatbush

[![build](https://travis-ci.org/dpmcmlxxvi/geojson-flatbush.svg?branch=master)](https://travis-ci.org/dpmcmlxxvi/geojson-flatbush)
[![coverage](https://img.shields.io/coveralls/dpmcmlxxvi/geojson-flatbush.svg)](https://coveralls.io/r/dpmcmlxxvi/geojson-flatbush?branch=master)
[![npm](https://badge.fury.io/js/geojson-flatbush.svg)](https://badge.fury.io/js/geojson-flatbush)

GeoJSON implementation of [Flatbush][flatbush-github] â€” A really fast **static spatial index** for 2D points and rectangles in JavaScript.

## INSTALL

#### npm

```bash
npm install --save geojson-flatbush
```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [GeojsonFlatbush](#geojsonflatbush)
    -   [Parameters](#parameters)
    -   [Examples](#examples)
    -   [index](#index)
    -   [add](#add)
        -   [Parameters](#parameters-1)
        -   [Examples](#examples-1)
    -   [finish](#finish)
        -   [Examples](#examples-2)
    -   [load](#load)
        -   [Parameters](#parameters-2)
        -   [Examples](#examples-3)
    -   [neighbors](#neighbors)
        -   [Parameters](#parameters-3)
        -   [Examples](#examples-4)
    -   [search](#search)
        -   [Parameters](#parameters-4)
        -   [Examples](#examples-5)
    -   [from](#from)
        -   [Parameters](#parameters-5)
        -   [Examples](#examples-6)

### GeojsonFlatbush

GeoJSON wrapper class for Flatbush.

#### Parameters

-   `numItems` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Number of items to store in static index.
-   `nodeSize` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Size of the tree node. (optional, default `16`)
-   `ArrayType` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Array type coordinate storage. (optional, default `Float64Array`)
-   `data`  

#### Examples

```javascript
// Initialize GeojsonFlatbush with features.
const index = new GeojsonFlatbush(2)
const collection = turf.featureCollection([
  turf.lineString([[0, 0], [1, 1]]),
  turf.lineString([[0, 1], [1, 2]]),
]);
index.load(collection);
index.finish();

// Query with polygon.
const polygon = turf.polygon([[[0, 0], [1, 0], [1, 1], [0, 1], [0, 0]]]);
const found = index.search(polygon, collection);
found.features.forEach((feature) => {
  // do something with found feature.
  console.log(feature);
});
```

#### index

Flatbush spatial index.

Type: Flatbush

#### add

Adds a single GeoJSON to the index.

##### Parameters

-   `data` **(GeoJSON | [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array))** GeoJSON or bounding box array.

##### Examples

```javascript
// Fill the index with a line string.
const line = turf.lineString([[0, 0], [1, 1]]);
index.add(line);
```

#### finish

Performs indexing of the added GeoJSON.

##### Examples

```javascript
// Perform the indexing. Should only be called once when done adding data.
index.finish()
```

#### load

Bulk load a collection to the index.

##### Parameters

-   `data` **(FeatureCollection | [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array))** GeoJSON or array of features/bboxes.

##### Examples

```javascript
// Fill the index with a feature collection.
const collection = turf.featureCollection([
  turf.lineString([[0, 0], [1, 1]]),
  turf.lineString([[0, 1], [1, 2]]),
]);
index.load(collection);
```

#### neighbors

Finds the K nearest neighbors from a point.

##### Parameters

-   `point` **point** Query point.
-   `maxResults` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Maximum number of results (= K). (optional, default `Infinity`)
-   `maxDistance` **[Number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Maximum distance from point allowed. (optional, default `Infinity`)
-   `collection` **GeoJSON** Source collection to select items from. (optional, default `null`)
-   `filterFn` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)?** Called on every found item (passing an item
                                 index) and only includes it if function
                                 returned a truthy value.

##### Examples

```javascript
// Find the 5 nearest neighbors.
const point = turf.point([0,0]);
const neighbors = index.neighbors(point, 5, Infinity, collection);
```

Returns **(FeatureCollection | [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array))** Features found or their IDs.

#### search

Find items in the bounding box of the GeoJSON.

##### Parameters

-   `geojson` **(GeoJSON | [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array))** GeoJSON or its bounding box.
-   `collection` **GeoJSON?** Source collection from which to return items.
-   `filterFn` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)?** Called on every found item (passing an item
                                 index) and only includes it if the function
                                 returned a truthy value.

##### Examples

```javascript
// Make a GeoJSON query.
const polygon = turf.polygon([[[0, 0], [1, 0], [1, 1], [0, 1], [0, 0]]]);
const found = index.search(polygon, collection);
```

Returns **([Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array) | FeatureCollection)** IDs or features found.

#### from

Instantiates a GeojsonFlatbush index from raw 'data' member.

##### Parameters

-   `data` **[ArrayBuffer](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer)** Raw indexing data array.

##### Examples

```javascript
// Reconstruct the index from a raw array buffer.
const index = GeojsonFlatbush.from(e.index.data);
```

Returns **[GeojsonFlatbush](#geojsonflatbush)** New instance of GeojsonFlatbush.

## TIPS

-   `GeojsonFlatbush` is really just a wrapper to `Flatbush` but just more GeoJSON friendly.
-   `GeojsonFlatbush`, just like its underlying spatial index, `Flatbush`, does not store
    the original data when using `add()` or `load()`. It only stores a bounding box and its
    ID (i.e., the order in which the data was added).
-   The query methods (`neighbors`, `search`) will return a `FeatureCollection` if a source
    collection is provided, but the order of the features in the source collection must
    match the order in which the original data was added.
-   It is probably not a good idea to combine using `add` and `load` since the order of the
    data will be needed to map the query output IDs to the original features. It is best to
    just add all your data to a single `FeatureCollection` for loading and querying. Unless
    you want to keep track of the ID order.
-   Web friendly API documentation can be found [here][geojson-flatbush-docs].

## BUILD

To build and test the library locally:

```shell
npm install
npm test
```

## LICENSE

Copyright (c) 2019 Daniel Pulido <mailto:dpmcmlxxvi@gmail.com>

Source code is released under the [MIT License](http://opensource.org/licenses/ISC).

[flatbush-github]: https://github.com/mourner/flatbush

[geojson-flatbush-docs]: https://dpmcmlxxvi.github.io/geojson-flatbush/
